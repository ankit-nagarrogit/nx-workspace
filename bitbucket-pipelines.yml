image: node:18

clone:
  depth: full

pipelines:
  branches:
    main:
      - step:
          name: Install Dependencies
          caches:
            - node
          script:
            - echo "ðŸ”§ Installing dependencies..."
            - npm ci
            - npx nx reset
          artifacts:
            - node_modules/**

      - parallel:
          - step:
              name: Simulate deploy: first-app
              script:
                - echo "ðŸš€ Checking affected projects for first-app..."
                - AFFECTED=$(npx nx show projects --affected --base=origin/main --head=HEAD)
                - echo "Affected projects: $AFFECTED"
                - |
                  if echo "$AFFECTED" | grep -q first-app; then
                    echo "First-app is affected. Building and deploying..."
                    npx nx build first-app
                    npm run deploy:first
                  else
                    echo "No changes in first-app â€” skipping."
                  fi

          - step:
              name: Simulate deploy: second-app
              script:
                - echo "Checking affected projects for second-app..."
                - AFFECTED=$(npx nx show projects --affected --base=origin/main --head=HEAD)
                - echo "Affected projects: $AFFECTED"
                - |
                  if echo "$AFFECTED" | grep -q second-app; then
                    echo "Second-app is affected. Building and deploying..."
                    npx nx build second-app
                    npm run deploy:second
                  else
                    echo "No changes in second-app â€” skipping."
                  fi
