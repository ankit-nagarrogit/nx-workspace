image: node:18

clone:
  depth: full

pipelines:
  branches:
    main:
      - step:
          name: Install dependencies
          caches:
            - node
          script:
            - npm ci
            - npx nx reset
          artifacts:
            - node_modules/**

      - parallel:
          - step:
              name: Build + Deploy first-app (if affected)
              script:
                - npx nx show projects --affected --base=origin/main --head=HEAD | grep first-app \
                  && npx nx build first-app \
                  && npm run deploy:first \
                  || echo "No changes in first-app"

          - step:
              name: Build + Deploy second-app (if affected)
              script:
                - npx nx show projects --affected --base=origin/main --head=HEAD | grep second-app \
                  && npx nx build second-app \
                  && npm run deploy:second \
                  || echo "No changes in second-app"
